const mapData = {
  minX: 1,
  maxX: 1000,
  minY: 1,
  maxY: 1000,
  blockedSpaces: {

    /* LOBBY */
    "127x20": true,
    "128x20": true,
    "129x20": true,
    "130x20": true,
    "131x20": true,
    "132x20": true,
    "133x20": true,
    "134x20": true,
    "135x20": true,
    "136x20": true,
    "137x20": true,
    "138x20": true,
    "139x20": true,
    "140x20": true,
    "141x20": true,

    "142x19": true,
    "142x18": true,
    "142x17": true,
    "142x16": true,
    "142x15": true,

    "127x14": true,
    "128x14": true,
    "129x14": true,
    "130x14": true,
    "131x14": true,
    "135x14": true,
    "136x14": true,
    "137x14": true,
    "138x14": true,
    "139x14": true,
    "140x14": true,
    "141x14": true,

    "126x19": true,
    "126x18": true,
    "126x17": true,
    "126x16": true,
    "126x15": true,

    "138x16": true,
    "139x16": true,
    "138x17": true,
    "139x17": true,

    
    "135x13": true,
    "134x12": true,
    "134x11": true,
    "133x10": true,
    "132x12": true,
    "132x11": true,
    "131x13": true,
    

    /* PERIMETER */
    "54x8": true,
    "55x8": true,
    "56x8": true,
    "54x9": true,
    "55x9": true,
    "56x9": true,
    "58x8": true,
    "59x8": true,
    "60x8": true,
    "58x9": true,
    "59x9": true,
    "60x9": true,
    "46x7": true,
    "47x7": true,
    "48x7": true,
    "49x7": true,
    "50x7": true,
    "51x7": true,
    "51x6": true,
    "52x5": true,
    "53x5": true,
    "54x5": true,
    "55x5": true,
    "56x5": true,
    "57x5": true,
    "58x5": true,
    "59x5": true,
    "60x5": true,
    "61x5": true,
    "62x6": true,
    "62x7": true,
    "62x8": true,
    "62x9": true,
    "52x9": true,
    "52x10": true,
    "53x10": true,
    "54x10": true,
    "55x10": true,
    "56x10": true,
    "57x10": true,
    "58x10": true,
    "59x10": true,
    "60x10": true,
    "61x10": true,
    "21x20": true,
    "21x19": true,
    "21x18": true,
    "44x3": true,
    "43x3": true,
    "42x3": true,
    "41x3": true,
    "40x3": true,
    "39x3": true,
    "38x3": true,
    "37x3": true,
    "35x3": true,
    "34x3": true,
    "33x3": true,
    "32x3": true,
    "31x3": true,
    "44x4": true,
    "43x4": true,
    "31x4": true, 
    "44x5": true,
    "43x5": true,
    "42x5": true,
    "40x5": true,
    "39x5": true,
    "38x5": true,
    "37x5": true,
    "36x5": true,
    "35x5": true,
    "34x5": true,
    "33x5": true,
    "32x5": true,
    "31x5": true,
    "46x6": true,
    "46x5": true,
    "46x4": true,
    "46x3": true,
    "46x2": true,
    "45x2": true,
    "44x2": true,
    "43x2": true,
    "42x1": true,
    "41x1": true,
    "40x1": true,
    "39x1": true,
    "38x1": true,
    "37x1": true,
    "36x1": true,
    "35x1": true,
    "34x1": true,
    "33x1": true,
    "32x1": true,
    "31x1": true,
    "30x1": true,
    "29x6": true,
    "29x5": true,
    "29x4": true,
    "29x3": true,
    "29x2": true,
    "45x7": true,
    "44x7": true,
    "43x7": true,
    "42x7": true,
    "39x7": true,
    "38x7": true,
    "37x7": true,
    "36x7": true,
    "35x7": true,
    "34x7": true,
    "33x7": true,
    "32x7": true,
    "31x7": true,
    "30x7": true,
    "45x8": true,
    "44x8": true,
    "43x8": true,
    "42x8": true,
    "39x8": true,
    "38x8": true,
    "37x8": true,
    "36x8": true,
    "35x8": true,
    "34x8": true,
    "33x8": true,
    "32x8": true,
    "31x8": true,
    "30x8": true,
    "41x13": true,
    "41x12": true,
    "41x11": true,
    "40x12": true,
    "39x12": true,
    "38x12": true,
    "37x12": true,
    "36x12": true,
    "35x12": true,
    "34x11": true,
    "33x12": true,
    "32x12": true,
    "41x10": true,
    "40x10": true,
    "39x10": true,
    "38x10": true,
    "37x10": true,
    "36x10": true,
    "35x10": true,
    "34x10": true,
    "33x10": true,
    "32x10": true,
    "32x15": true,
    "33x15": true,
    "34x15": true,
    "36x15": true,
    "37x15": true,
    "38x15": true,
    "41x19": true,
    "41x18": true,
    "41x16": true,
    "41x15": true,
    "40x16": true,
    "39x16": true,
    "38x16": true,
    "37x16": true,
    "36x16": true,
    "35x16": true,
    "34x16": true,
    "33x16": true,
    "36x18": true,
    "35x18": true,
    "34x18": true,
    "33x18": true,
    "28x19": true,
    "27x19": true,
    "26x19": true,
    "25x19": true,
    "24x19": true,
    "23x19": true,
    "24x18": true,
    "23x18": true,
    "21x21": true,
    "22x21": true,
    "23x21": true,
    "24x21": true,
    "25x21": true,
    "26x21": true,
    "27x21": true,
    "28x21": true,
    "29x21": true,
    "30x21": true,
    "21x13": true,
    "21x14": true,
    "21x15": true,
    "22x14": true,
    "23x14": true,
    "24x14": true,
    "25x14": true,
    "26x14": true,
    "27x14": true,
    "28x14": true,
    "29x14": true,
    "30x14": true,
    "31x10": true,
    "31x11": true,
    "31x12": true,
    "31x13": true,
    "31x14": true,
    "31x15": true,
    "31x16": true,
    "31x17": true,
    "31x18": true,
    "31x19": true,
    "31x21": true,
    "32x21": true,
    "33x21": true,
    "34x21": true,
    "35x21": true,
    "36x21": true,
    "37x21": true,
    "38x21": true,
    "39x21": true,
    "40x21": true,
    "41x21": true,
    "31x20": true,
    "32x20": true,
    "33x20": true,
    "34x20": true,
    "35x20": true,
    "36x20": true,
    "37x20": true,
    "38x20": true,
    "39x20": true,
    "40x20": true,
    "41x20": true,
    "26x15": true,
    "26x16": true,
    "27x16": true,
    "28x16": true,
    "29x16": true,
    "30x12": true,
    "28x9": true,
    "29x9": true,
    "28x10": true,
    "29x10": true,
    "28x11": true,
    "21x12": true,
    "22x13": true,
    "23x11": true,
    "23x12": true,
    "24x13": true,
    "25x11": true,
    "25x12": true,
    "26x13": true,
    "27x13": true,
    "28x13": true,
    "29x13": true, 
    "25x7": true,
    "25x8": true,
    "26x8": true,
    "27x8": true,
    "23x6": true,
    "24x6": true,
    "22x7": true,
    "23x8": true,
    "17x6": true,
    "18x6": true,
    "19x6": true,
    "20x6": true,
    "21x7": true,
    "21x8": true,
    "21x9": true,
    "22x9": true,
    "23x9": true,
    "9x7": true,
    "10x7": true,
    "11x7": true,
    "12x7": true,
    "13x7": true,
    "14x7": true,
    "15x7": true,
    "16x7": true,
    "16x8": true,
    "16x9": true,
    "9x13": true,
    "10x13": true,
    "11x13": true,
    "12x13": true,
    "13x13": true,
    "14x13": true,
    "15x13": true,
    "15x13": true,
    "9x14": true,
    "10x14": true,
    "11x15": true,
    "12x15": true,
    "13x15": true,
    "14x15": true,
    "15x15": true,
    "16x11": true,
    "16x12": true,
    "16x13": true,
    "16x14": true,
    "16x15": true,
    "16x16": true,
    "8x8": true,
    "8x9": true,
    "8x10": true,
    "8x11": true,
    "8x12": true,
    "8x13": true,
    "8x14": true,
    "8x15": true,
    "8x16": true,
    "8x17": true,
    "8x18": true,
    "9x19": true,
    "10x17": true,
    "10x18": true,
    "11x17": true,
    "11x18": true,
    "12x19": true,
    "14x17": true,
    "14x18": true,
    "13x17": true,
    "13x18": true,
    "15x19": true,
    "16x20": true,
    "16x19": true,
    "16x18": true,
    "9x21": true,
    "10x21": true,
    "11x21": true,
    "12x21": true,
    "13x21": true,
    "14x21": true,
    "15x21": true,
    "16x21": true,
    "9x25": true,
    "9x26": true,
    "9x27": true,
    "9x28": true,
    "9x29": true,
    "9x30": true,
    "9x31": true,
    "9x32": true,
    "9x33": true,
    "9x34": true,
    "3x35": true,
    "7x34": true,
    "6x34": true,
    "5x34": true,
    "4x34": true,
    "3x33": true,
    "7x32": true,
    "6x32": true,
    "5x32": true,
    "4x32": true,
    "3x31": true,
    "7x30": true,
    "6x30": true,
    "5x30": true,
    "4x30": true,
    "3x29": true,
    "7x28": true,
    "6x28": true,
    "5x28": true,
    "4x28": true,
    "3x27": true,
    "7x26": true,
    "6x26": true,
    "5x26": true,
    "4x26": true,
    "3x25": true,
    "7x24": true,
    "6x24": true,
    "5x24": true,
    "4x24": true,
    "3x23": true,
    "7x22": true,
    "6x22": true,
    "5x22": true,
    "4x22": true,
    "8x22": true,
    "71x37": true,
    "70x37": true,
    "69x38": true,
    "68x38": true,
    "67x38": true,
    "66x38": true,
    "65x38": true,
    "64x38": true,
    "63x38": true,
    "62x38": true,
    "61x38": true,
    "60x38": true,
    "59x38": true,
    "58x38": true,
    "57x38": true,
    "56x38": true,
    "55x38": true,
    "54x38": true,
    "53x38": true,
    "52x38": true,
    "51x38": true,
    "50x38": true,
    "49x38": true,
    "48x38": true,
    "47x38": true,
    "46x38": true,
    "45x38": true,
    "44x38": true,
    "43x38": true,
    "42x38": true,
    "41x38": true,
    "40x38": true,
    "39x38": true,
    "38x38": true,
    "37x38": true,
    "36x38": true,
    "35x38": true,
    "34x38": true,
    "33x38": true,
    "32x38": true,
    "31x38": true,
    "30x38": true,
    "29x38": true,
    "28x38": true,
    "27x38": true,
    "26x38": true,
    "25x38": true,
    "24x38": true,
    "23x38": true,
    "22x38": true,
    "21x38": true,
    "20x38": true,
    "19x38": true,
    "18x38": true,
    "17x38": true,
    "16x38": true,
    "15x38": true,
    "14x38": true,
    "13x38": true,
    "12x38": true,
    "11x38": true,
    "10x38": true,
    "9x38": true,
    "8x37": true,
    "7x36": true,
    "6x36": true,
    "5x36": true,
    "4x36": true,
    "87x48": true,
    "87x47": true,
    "87x46": true,
    "87x45": true,
    "77x41": true,
    "78x41": true,
    "79x41": true,
    "80x41": true,
    "81x41": true,
    "82x41": true,
    "84x41": true,
    "83x41": true,
    "83x41": true,
    "84x41": true,
    "85x41": true,
    "86x41": true,
    "87x41": true,
    "77x42": true,
    "78x42": true,
    "79x42": true,
    "80x42": true,
    "81x42": true,
    "82x42": true,
    "84x42": true,
    "83x42": true,
    "83x42": true,
    "84x42": true,
    "85x42": true,
    "86x42": true,
    "87x42": true,
    "72x41": true,
    "73x41": true,
    "74x41": true,
    "75x41": true,
    "72x42": true,
    "73x42": true,
    "74x42": true,
    "75x42": true,
    "71x38": true,
    "71x39": true,
    "71x40": true,
    "71x41": true,
    "71x42": true,
    "71x43": true,
    "71x44": true,
    "71x45": true,
    "71x46": true,
    "71x47": true,
    "71x48": true,
    "72x49": true,
    "73x49": true,
    "74x49": true,
    "75x49": true,
    "76x49": true,
    "77x49": true,
    "78x49": true,
    "79x49": true,
    "80x49": true,
    "81x49": true,
    "82x49": true,
    "84x48": true,
    "83x48": true,
    "83x49": true,
    "82x50": true,
    "81x51": true,
    "80x52": true,
    "79x53": true,
    "79x54": true,
    "79x55": true,
    "79x56": true,
    "80x57": true,
    "81x58": true,
    "82x59": true,
    "83x60": true,
    "84x61": true,
    "85x61": true,
    "86x61": true,
    "87x61": true,
    "88x60": true,
    "89x59": true,
    "90x58": true,
    "91x57": true,
    "92x56": true,
    "92x55": true,
    "92x54": true,
    "92x53": true,
    "93x53": true,
    "94x53": true,
    "95x53": true,
    "96x52": true,
    "96x51": true,
    "96x50": true,
    "96x49": true,
    "96x48": true,
    "96x47": true,
    "96x46": true,
    "96x45": true,
    "96x44": true,
    "96x43": true,
    "96x42": true,
    "96x41": true,
    "95x40": true,
    "95x39": true,
    "94x39": true,
    "94x38": true,
    "93x38": true,
    "93x37": true,
    "92x37": true,
    "92x36": true,
    "92x35": true,
    "92x34": true,
    "95x38": true,
    "96x38": true,
    "97x38": true,
    "98x38": true,
    "99x38": true,
    "100x38": true,
    "101x38": true,
    "102x38": true,
    "103x37": true,
    "103x36": true,
    "104x35": true,
    "104x34": true,
    "104x33": true,
    "104x32": true,
    "104x31": true,
    "103x30": true,
    "102x30": true,
    "101x30": true,
    "100x30": true,
    "99x30": true,
    "98x30": true,
    "97x30": true,
    "96x30": true,
    "95x30": true,
    "94x30": true,
    "93x30": true,
    "92x30": true,
    "91x30": true,
    "91x31": true,
    "90x29": true,
    "89x28": true,
    "88x27": true,
    "87x26": true,
    "86x26": true,
    "85x26": true,
    "84x26": true,
    "83x26": true,
    "82x26": true,
    "81x26": true,
    "81x25": true,
    "81x24": true,
    "81x23": true,
    "82x25": true,
    "83x25": true,
    "84x25": true,
    "85x25": true,
    "86x25": true,
    "87x25": true,
    "83x24": true,
    "84x24": true,
    "85x24": true,
    "83x23": true,
    "84x23": true,
    "85x23": true,  
    "87x24": true,
    "87x23": true,
    "87x22": true,
    "87x21": true,
    "87x20": true,
    "86x20": true,
    "85x20": true,
    "84x20": true,
    "83x20": true,
    "82x20": true,
    "81x20": true,
    "81x19": true,
    "87x18": true,
    "86x18": true,
    "85x18": true,
    "84x18": true,
    "83x18": true,
    "82x18": true,
    "81x18": true,
    "88x17": true,
    "88x16": true,
    "88x15": true,
    "88x14": true,
    "88x13": true,
    "81x12": true,
    "82x12": true,
    "83x12": true,
    "84x12": true,
    "85x12": true,
    "86x12": true,
    "87x12": true,
    "81x14": true,
    "80x14": true,
    "80x13": true,
    "80x12": true,
    "77x11": true,
    "78x11": true,
    "79x11": true,
    "75x14": true,
    "76x14": true,
    "76x13": true,
    "76x12": true,
    "75x21": true,
    "74x21": true,
    "73x21": true,
    "72x21": true,
    "71x21": true,
    "70x21": true,
    "69x21": true,
    "68x21": true,
    "67x21": true,
    "66x21": true,
    "65x21": true,
    "64x21": true,
    "63x21": true,
    "62x21": true,
    "61x21": true,
    "60x21": true,
    "59x21": true,
    "58x21": true,
    "57x21": true,
    "56x21": true,
    "55x21": true,
    "54x21": true,
    "53x21": true,
    "52x21": true,
    "75x20": true,
    "74x20": true,
    "73x20": true,
    "72x20": true,
    "71x20": true,
    "70x20": true,
    "69x20": true,
    "68x20": true,
    "67x20": true,
    "66x20": true,
    "65x20": true,
    "64x20": true,
    "63x20": true,
    "62x20": true,
    "61x20": true,
    "60x20": true,
    "59x20": true,
    "58x20": true,
    "57x20": true,
    "56x20": true,
    "55x20": true,
    "54x20": true,
    "53x20": true,
    "52x20": true,
    "75x17": true,
    "75x18": true,
    "75x19": true,
    "74x17": true,
    "74x18": true,
    "74x19": true,
    "71x18": true,
    "72x18": true,
    "73x18": true,
    "71x19": true,
    "72x19": true,
    "73x19": true,
    "71x13": true,
    "72x13": true,
    "73x13": true,
    "71x14": true,
    "72x14": true,
    "73x14": true,
    "68x17": true,
    "68x18": true,
    "68x19": true,
    "69x17": true,
    "69x18": true,
    "69x19": true,
    "68x12": true,
    "68x13": true,
    "68x14": true,
    "69x12": true,
    "69x13": true,
    "69x14": true,
    "62x11": true,
    "63x11": true,
    "64x11": true,
    "65x11": true,
    "66x11": true,
    "67x11": true,
    "68x11": true,
    "69x11": true,
    "70x11": true,
    "71x11": true,
    "72x11": true,
    "73x11": true,
    "74x11": true,
    "75x11": true,
    "62x13": true,
    "63x13": true,
    "64x13": true,
    "65x13": true,
    "62x14": true,
    "63x14": true,
    "64x14": true,
    "65x14": true,
    "62x15": true,
    "62x16": true,
    "62x17": true,
    "63x17": true,
    "64x17": true,
    "65x17": true,
    "63x18": true,
    "64x18": true,
    "65x18": true,
    "52x11": true,
    "52x12": true,
    "53x12": true,
    "54x12": true,
    "55x12": true,
    "56x12": true,
    "57x12": true,
    "58x12": true,
    "59x12": true,
    "60x12": true,
    "61x12": true,
    "52x13": true,
    "53x13": true,
    "54x13": true,
    "54x14": true,
    "52x15": true,
    "52x16": true,
    "52x17": true,
    "52x18": true,
    "52x19": true,
    "53x19": true,
    "53x16": true,
    "54x16": true,
    "56x14": true,
    "56x15": true,
    "56x16": true,
    "56x17": true,
    "56x18": true,
    "57x16": true,
    "57x17": true,
    "57x18": true,
    "58x17": true,
    "58x18": true,
    "59x18": true,
    "60x18": true,
    "59x19": true,
    "60x19": true,
    "61x19": true,
    "60x15": true,
    "61x15": true,

    /* UPPER RIGHT ROOM STOOLS */
    "81x17": true,
    "84x17": true,
    "85x16": true,
    "86x16": true,
    "86x15": true,
    "84x14": true,
    "82x15": true,

    /* BOTTOM HOLLOW GAP */
    "93x50": true,
    "93x49": true,
    "93x48": true,
    "93x47": true,
    "93x46": true,
    "93x45": true,
    "93x44": true,
    "93x43": true,
    "93x42": true,
    "93x41": true,
    "92x50": true,
    "92x49": true,
    "92x48": true,
    "92x47": true,
    "92x46": true,
    "92x45": true,
    "92x44": true,
    "92x43": true,
    "92x42": true,
    "92x41": true,
    "92x40": true,

    /* BOTTOM ROTUNDA TABLES */
    "83x57": true,
    "84x57": true,
    "83x56": true,
    "84x56": true,
    "83x53": true,
    "84x53": true,
    "83x52": true,
    "84x52": true,
    "87x57": true,
    "88x57": true,
    "87x56": true,
    "88x56": true,
    "87x53": true,
    "88x53": true,
    "87x52": true,
    "88x52": true,

    /* LIBRARY SHELVES */
    "93x34": true,
    "94x34": true,
    "95x34": true,
    "96x34": true,
    "97x34": true,
    "93x32": true,
    "94x32": true,
    "95x32": true,
    "96x32": true,
    "97x32": true,
    "98x32": true,
    "99x32": true,
    "100x32": true,
    "96x36": true,
    "97x36": true,
    "98x36": true,
    "99x36": true,
    "100x36": true,
    "101x36": true,
    "99x34": true,
    "100x34": true,
    "101x34": true,
    "102x34": true,
    "102x32": true,
    "103x32": true,

    /* GYM ROTUNDA WALLS AND TABLES */
    "72x34": true,
    "73x34": true,
    "73x35": true,
    "74x35": true,
    "75x35": true,
    "76x35": true,
    "77x35": true,
    "77x34": true,
    "78x33": true,
    "78x32": true,
    "79x33": true,
    "79x32": true,
    "80x34": true,
    "81x34": true,
    "82x33": true,
    "82x32": true,
    "83x33": true,
    "83x32": true,
    "84x34": true,
    "85x34": true,
    "86x34": true,
    "87x34": true,
    "78x34": true,
    "79x34": true,
    "80x35": true,
    "81x35": true,
    "82x35": true,
    "83x35": true,
    "84x35": true,
    "87x37": true,
    "87x37": true,
    "87x38": true,
    "87x39": true,
    "87x40": true,
    "78x28": true,
    "79x28": true,
    "78x29": true,
    "79x29": true,
    "82x28": true,
    "83x28": true,
    "82x29": true,
    "83x29": true,

    /* INNER WALLS AND BORDERS */
    "33x28": true,
    "34x28": true,
    "35x28": true,
    "36x28": true,
    "37x28": true,
    "38x28": true,
    "39x28": true,
    "40x28": true,
    "37x31": true,
    "38x31": true,
    "39x31": true,
    "40x31": true,
    "37x32": true,
    "32x27": true,
    "32x28": true,
    "32x29": true,
    "32x30": true,
    "32x31": true,
    "32x32": true,
    "22x27": true,
    "22x29": true,
    "22x30": true,
    "22x32": true,
    "23x30": true,
    "24x30": true,
    "24x29": true,
    "25x29": true,
    "26x30": true,
    "26x29": true,
    "28x30": true,
    "28x29": true,
    "30x28": true,
    "30x29": true,
    "30x30": true,
    "41x25": true,
    "40x25": true,
    "39x25": true,
    "38x25": true,
    "37x25": true,
    "36x25": true,
    "35x25": true,
    "34x25": true,
    "33x25": true,
    "32x25": true,
    "31x25": true,
    "30x25": true,
    "29x25": true,
    "28x25": true,
    "27x25": true,
    "26x25": true,
    "25x25": true,
    "24x25": true,
    "23x25": true,
    "22x25": true,
    "22x26": true,
    "31x26": true,
    "30x26": true,
    "29x26": true,
    "28x26": true,
    "27x26": true,
    "26x26": true,
    "25x26": true,
    "24x26": true,
    "23x26": true,
    "41x25": true,
    "41x26": true,
    "41x27": true,
    "41x28": true,
    "41x29": true,
    "41x30": true,
    "41x31": true,
    "41x32": true,
    "41x33": true,
    "41x34": true,
    "40x34": true,
    "39x34": true,
    "38x34": true,
    "37x34": true,
    "36x34": true,
    "34x34": true,
    "33x34": true,
    "32x34": true,
    "31x34": true,
    "30x34": true,
    "29x34": true,
    "28x34": true,
    "27x34": true,
    "26x34": true,
    "25x34": true,
    "24x34": true,
    "23x34": true,
    "22x34": true,
    "41x33": true,
    "40x33": true,
    "39x33": true,
    "38x33": true,
    "37x33": true,
    "36x33": true,
    "34x33": true,
    "33x33": true,
    "32x33": true,
    "31x33": true,
    "30x33": true,
    "29x33": true,
    "28x33": true,
    "27x33": true,
    "26x33": true,
    "25x33": true,
    "24x33": true,
    "23x33": true,
    "22x33": true,
    "42x27": true,
    "43x27": true,
    "42x28": true,
    "43x28": true,
    "42x30": true,
    "43x30": true,
    "42x31": true,
    "43x31": true,
    "57x27": true,
    "57x28": true,
    "57x29": true,
    "57x30": true,
    "57x31": true,
    "48x30": true,
    "49x30": true,
    "49x29": true,
    "50x29": true,
    "51x30": true,
    "51x29": true,
    "53x30": true,
    "53x29": true,
    "55x28": true,
    "55x29": true,
    "55x30": true,
    "46x29": true,
    "46x30": true,
    "46x31": true,
    "56x32": true,
    "55x32": true,
    "54x32": true,
    "53x32": true,
    "52x32": true,
    "51x32": true,
    "50x32": true,
    "49x32": true,
    "48x32": true,
    "47x32": true,
    "47x33": true,
    "75x25": true,
    "74x25": true,
    "73x25": true,
    "72x25": true,
    "71x25": true,
    "70x25": true,
    "69x25": true,
    "68x25": true,
    "67x25": true,
    "66x25": true,
    "65x25": true,
    "64x25": true,
    "63x25": true,
    "62x25": true,
    "61x25": true,
    "60x25": true,
    "59x25": true,
    "58x25": true,
    "57x25": true,
    "56x25": true,
    "55x25": true,
    "54x25": true,
    "53x25": true,
    "52x25": true,
    "51x25": true,
    "50x25": true,
    "49x25": true,
    "48x25": true,
    "47x25": true,
    "56x26": true,
    "55x26": true,
    "54x26": true,
    "53x26": true,
    "52x26": true,
    "51x26": true,
    "50x26": true,
    "49x26": true,
    "48x26": true,
    "47x26": true,
    "47x27": true,
    "75x26": true,
    "75x27": true,
    "74x28": true,
    "73x29": true,
    "72x30": true,
    "71x31": true,
    "70x32": true,
    "69x33": true,
    "68x34": true,
    "67x34": true,
    "66x34": true,
    "65x34": true,
    "65x33": true,
    "66x33": true,
    "67x32": true,
    "67x31": true,
    "67x30": true,
    "67x29": true,
    "66x28": true,
    "65x28": true,
    "64x28": true,
    "63x28": true,
    "62x28": true,
    "61x28": true,
    "60x28": true,
    "59x28": true,
    "58x29": true,
    "58x30": true,
    "59x31": true,
    "60x31": true,
    "61x31": true,
    "62x31": true,
    "62x32": true,
    "63x33": true,
    "63x34": true,
    "62x34": true,
    "61x34": true,
    "60x34": true,
    "59x34": true,
    "58x34": true,
    "57x34": true,
    "56x34": true,
    "55x34": true,
    "54x34": true,
    "53x34": true,
    "52x34": true,
    "51x34": true,
    "50x34": true,
    "49x34": true,
    "48x34": true,
    "47x34": true,

    /* TOP LEFT ROOM INTERIOR */
    "11x9": true,
    "11x10": true,
    "11x11": true,
    "12x11": true,
    "14x11": true,
    "14x10": true,
    "14x9": true,
    "13x9": true,

    /* TOP LEFT ROTUNDA */
    "13x34": true,
    "13x33": true,
    "12x33": true,
    "12x32": true,
    "11x32": true,
    "11x31": true,
    "11x30": true,
    "11x29": true,
    "11x28": true,
    "11x27": true,
    "12x27": true,
    "12x26": true,
    "13x26": true,
    "13x25": true,
    "17x34": true,
    "17x33": true,
    "18x33": true,
    "18x32": true,
    "19x32": true,
    "19x31": true,
    "19x30": true,
    "19x29": true,
    "19x28": true,
    "19x27": true,
    "18x27": true,
    "18x26": true,
    "17x26": true,
    "17x25": true,
    "14x30": true,
    "15x30": true,
    "16x30": true,
    "14x29": true,
    "15x29": true,
    "16x29": true,
    "14x28": true,
    "15x28": true,
    "16x28": true,

    /* UPPER WING TABLES */
    "48x8": true,
    "49x8": true,
    "48x9": true,
    "49x9": true,
    "48x11": true,
    "49x11": true,
    "48x12": true,
    "49x12": true,
    "48x13": true,
    "49x13": true,
    "48x14": true,
    "49x14": true,
    "48x16": true,
    "49x16": true,
    "48x17": true,
    "49x17": true,
    "48x19": true,
    "49x19": true,
    "48x20": true,
    "49x20": true,
    "44x19": true,
    "45x19": true,
    "44x20": true,
    "45x20": true,
    "44x17": true,
    "45x17": true,
    "44x18": true,
    "45x18": true,
    "44x14": true,
    "45x14": true,
    "44x15": true,
    "45x15": true,
    "44x11": true,
    "45x11": true,
    "44x12": true,
    "45x12": true,
  },
};

const skinID = ["zero", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine"];

const meetingSpots = [
  { i: 72, j: 95 },
  { i: 73, j: 95 },
  { i: 74, j: 95 },
  { i: 75, j: 95 },
  { i: 76, j: 95 },
  { i: 77, j: 95 },
  { i: 78, j: 95 },
  { i: 79, j: 95 },
  { i: 80, j: 95 },
  { i: 81, j: 95 },
  { i: 82, j: 95 },
  { i: 83, j: 95 },
];

//Misc Helpers
function randomFromArray(array) {
  return array[Math.floor(Math.random() * array.length)];
}
function getKeyString(x, y) {
  return `${x}x${y}`;
}

function isSolid(x,y) {
  const blockedNextSpace = mapData.blockedSpaces[getKeyString(x, y)];
  return (
    blockedNextSpace ||
    x >= mapData.maxX ||
    x < mapData.minX ||
    y >= mapData.maxY ||
    y < mapData.minY
  );
}


function getRandomVotingCardSpot() {
  return randomFromArray([
    { i: 84, j: 54 },
    //{ i: 103, j: 31 },
    //{ i: 82, j: 24 },
    //{ i: 79, j: 46 },
    //{ i: 59, j: 29 },
    //{ i: 81, j: 13 },
    //{ i: 61, j: 13 },
    //{ i: 45, j: 3 },
    //{ i: 32, j: 16 },
    //{ i: 31, j: 32 },
    //{ i: 27, j: 15 },
  ]);
}

function getRandomGunSpot() {
  return randomFromArray([
    { i: 85, j: 54 },
    //{ i: 9, j: 9 },
    //{ i: 4, j: 29 },
    //{ i: 23, j: 7 },
  ]);
}

function getRandomFlashlightSpot() {
  return randomFromArray([
    { i: 86, j: 54 },
  ]);
}

function getRandomMagnifyingGlassSpot() {
  return randomFromArray([
    { i: 87, j: 54 },
  ]);
}

function getRandomHaloSpot() {
  return randomFromArray([
    { i: 88, j: 54 },
  ]);
}

(function () {

  var heldKeys = [];
  var waitingKeys = [];
  let playerId;
  let playerRef;
  let players = {};
  let playerElements = {};
  let votesRef = {};
  let votingCards = {};
  let votingCardElements = {};
  let guns = {};
  let gunElements = {};
  let flashlights = {};
  let flashlightElements = {};
  let magnifyingGlasses = {};
  let magnifyingGlassElements = {};
  let halos = {};
  let haloElements = {};
  let inRound = false;
  let inLobby = true;
  const startingX = 133;
  const startingY = 17;
  let startTime;
  let time;
  let clock;
  let clockInterval;
  let playerOrder = [];
  let inTitleScreen = true;
  let inMafiaVoting = false;
  let inAngelVoting = false;
  let inDetectiveVoting = false;
  let inShooterVoting = false;
  let inTownVoting = false;                               
  let isDetective = false;
  let isAngel = false;
  let isShooter = false;
  let isVoters = false;


  const gameContainer = document.querySelector(".game-container");
  const playerSkinButton = document.querySelector("#b2");
  const startButton = document.querySelector("#b1");

  function startClock() {
    startTime = 5/60; //min
    time = startTime * 60; //secs
    clock = document.createElement("div");
    clock.classList.add("timer");
    setTimeout(function () {
      document.querySelector(".gameInterface").appendChild(clock);
    },1000);
    clockInterval = setInterval(updateCountdown, 1000);
  }

  function updateCountdown() {

    const minutes = Math.floor(time/60);
    let seconds = time % 60;

    seconds = seconds < 10 ? '0' + seconds : seconds;

    clock.innerHTML = `${minutes}:${seconds}`;
    time--;

    if (time === 0) {
      setTimeout(function() {
        endRound();
      }, 1500);
    }

  }

  function firstRound(){
    Object.keys(players).forEach((key) => {
      playerOrder.unshift(key);
    });
    if (playerOrder[0] === playerId) {
      console.log("I am the admin")

      firebase.database().ref(`votes`).set({
        mafiaVote: "none",
        angelVote: "none",
        detectiveVote: "none",
        shooterVote: "none",
        townVote: "none",
      });

      let numMafia = 0;
      const numPlayer = playerOrder.length;
      if (numPlayer === 2) {
        numMafia = 1;
      }
      else if (numPlayer === 3) {
        numMafia = 1;
      }
      else if (numPlayer === 4) {
        numMafia = 1;
      }
      else if (numPlayer === 5) {
        numMafia = 2;
      }
      else if (numPlayer === 6) {
        numMafia = 2;
      }
      else if (numPlayer === 7) {
        numMafia = 2;
      }
      else if (numPlayer === 8) {
        numMafia = 3;
      }
      else if (numPlayer === 9) {
        numMafia = 3;
      }
      else if (numPlayer === 10) {
        numMafia = 3;
      }
      else if (numPlayer === 11) {
        numMafia = 4;
      }
      else if (numPlayer === 12) {
        numMafia = 4;
      }
      for (let i = 0; i < numMafia; i++) {
        let currPlayer = playerOrder[Math.floor(Math.random() * numPlayer)];
        while (players[currPlayer].mafia) {
          currPlayer = playerOrder[Math.floor(Math.random() * numPlayer)];
        }
        firebase.database().ref(`players/${currPlayer}/mafia`).set(true);
        console.log("Mafia: " + currPlayer);
      }
    }
  }

  function startRound() {
    if (players[playerId].mafia) {
      const youAreMafia = document.createElement("div");
      youAreMafia.classList.add("youAreMafiaBig");
      youAreMafia.innerHTML = `YOU ARE MAFIA`;
      document.querySelector(".gameInterface").appendChild(youAreMafia);

      setTimeout(function() {
        youAreMafia.classList.add("youAreMafia");
        youAreMafia.classList.remove("youAreMafiaBig");
      }, 800);
    }

    startClock();

    inRound = true;

    const backpack = document.createElement("div");
    backpack.classList.add("backpack");
    document.querySelector(".gameInterface").appendChild(backpack);
    
    const flashlightIcon = document.createElement("div");
    flashlightIcon.classList.add("flashlightIcon");
    if (players[playerId].flashlight) {
      flashlightIcon.style.background = "url(images/items/flashlightIcon.png)";
    }
    backpack.appendChild(flashlightIcon);
    
    const gunIcon = document.createElement("div");
    gunIcon.classList.add("gunIcon");
    backpack.appendChild(gunIcon);

    const haloIcon = document.createElement("div");
    haloIcon.classList.add("haloIcon");
    backpack.appendChild(haloIcon);

    const magnifyingGlassIcon = document.createElement("div");
    magnifyingGlassIcon.classList.add("magnifyingGlassIcon");
    backpack.appendChild(magnifyingGlassIcon);

    const votingCardIcon = document.createElement("div");
    votingCardIcon.classList.add("votingCardIcon");
    backpack.appendChild(votingCardIcon);

    if (players[playerId].flashlight){
      const shadowBig = document.createElement("div");
      shadowBig.classList.add("shadowBig");
      shadowBig.style.background = "url(images/maps/shadowUp.png)";
      document.querySelector(".gameInterface").appendChild(shadowBig);
    }
    else {
      const shadow = document.createElement("div");
      shadow.classList.add("shadow");
      shadow.style.background = "url(images/maps/shadowUp.png)";
      document.querySelector(".gameInterface").appendChild(shadow);
    }
  }

  function endRound() {
    inRound = false;
    clearInterval(clockInterval);
    clock.remove();

    isDetective = false;
    isAngel = false;
    isShooter = false;
    isVoters = false;

    Object.keys(players).forEach((key) => {
      if (players[key].magnifyingGlass) {
        isDetective = true;
      }
      if (players[key].halo) {
        isAngel = true;
      }
      if (players[key].gun) {
        isShooter = true;
      }
      if (players[key].votingCard) {
        isVoters = true;
      }
    });

    const index = playerOrder.indexOf(playerId);
    const {i,j} = meetingSpots[index];
    teleportTo(i, j);
    setTimeout(function() {
      if (players[playerId].mafia) {
        document.querySelector(".youAreMafia").classList.add("hideYouAreMafia");
        document.querySelector(".youAreMafia").classList.remove("youAreMafia");
        setTimeout(function() {
          document.querySelector(".hideYouAreMafia").remove();
        }, 500);
      }

      document.querySelector(".backpack").classList.add("backpackClose");
      document.querySelector(".backpack").classList.remove("backpack");
      setTimeout(function() {
        document.querySelector(".backpackClose").remove();
      }, 500);

      if (players[playerId].flashlight){
        document.querySelector(".shadowBig").remove();
      }
      else {
        document.querySelector(".shadow").remove();
      }
      Object.keys(players).forEach((key) => {
        players[key].direction = "down";
        players[key].walking = "no";
        firebase.database().ref(`players/${key}`).update({
          walking: "no",
          direction: "down",
        });
      });
    }, 800);
    setTimeout(function() {
      if (players[playerId].mafia) {
        startMafiaVoting();
      }
      else {
        startMafiaWaiting();
      }
    }, 2300);
  }

  function nextRound() {
    firebase.database().ref(`votes`).update({
      mafiaVote: "none",
      angelVote: "none",
      detectiveVote: "none",
      shooterVote: "none",
      townVote: "none",
    });
    Object.keys(players).forEach((key) => {
      firebase.database().ref(`players/${key}`).update({
        gun: false,
        halo: false,
        magnifyingGlass: false,
        votingCard: false,
      });
    });
  }

  // GENERAL VOTING 

  function confirmVote(ID, roundInterface) {
    const blocker = document.createElement("div");
    blocker.classList.add("blocker");
    roundInterface.appendChild(blocker);

    const votingConfirmUI = document.createElement("div");
    votingConfirmUI.classList.add("votingConfirmUI");
    votingConfirmUI.innerHTML = `ARE YOU SURE YOU WANT TO VOTE FOR THIS PERSON?`
    if (inAngelVoting) {
      votingConfirmUI.innerHTML = `ARE YOU SURE YOU WANT TO SAVE THIS PERSON?`
    }
    if (inDetectiveVoting) {
      votingConfirmUI.innerHTML = `ARE YOU SURE YOU WANT TO INVESTIGATE THIS PERSON?`
    }
    if (inShooterVoting) {
      votingConfirmUI.innerHTML = `ARE YOU SURE YOU WANT TO TAKE OUT THIS PERSON?`
    }
    roundInterface.appendChild(votingConfirmUI);

    const buttonYes = document.createElement("div");
    buttonYes.classList.add("buttonYes");
    buttonYes.innerHTML = `YES`;
    buttonYes.addEventListener("click", () => {
      confirmYes(ID, roundInterface);
    });
    document.querySelector(".votingConfirmUI").appendChild(buttonYes);

    const buttonNo = document.createElement("div");
    buttonNo.classList.add("buttonNo");
    buttonNo.innerHTML = `NO`;
    buttonNo.addEventListener("click", () => {
      confirmNo(ID);
    });
    document.querySelector(".votingConfirmUI").appendChild(buttonNo);
  }

  function confirmYes(ID, roundInterface) {
    const voteUpdate = players[ID].votes + 1;
    firebase.database().ref(`players/${ID}/votes`).set(voteUpdate);

    firebase.database().ref(`players/${playerId}/voteFor`).set(ID);

    document.querySelector(".potentialVote").remove();

    const myVote = document.createElement("div");
    myVote.classList.add("myVote");
    const divLeft = (16 * (players[ID].x - players[playerId].x)) + 185 + "px";
    myVote.style.left = divLeft;
    roundInterface.appendChild(myVote);

    document.querySelector(".votingConfirmUI").classList.add("votingConfirmUIClose");
    document.querySelector(".votingConfirmUI").classList.remove("votingConfirmUI");
    document.querySelector(".blocker").remove();
    setTimeout(function () {
      document.querySelector(".votingConfirmUIClose").remove();
    }, 1200);
  }

  function confirmNo(ID) {
    document.querySelector(".potentialVote").remove();

    document.querySelector(".votingConfirmUI").classList.add("votingConfirmUIClose");
    document.querySelector(".votingConfirmUI").classList.remove("votingConfirmUI");
    document.querySelector(".blocker").remove();
    setTimeout(function () {
      document.querySelector(".votingConfirmUIClose").remove();
    }, 1200);
  }

  function changeVote(ID, roundInterface) {
    const blocker = document.createElement("div");
    blocker.classList.add("blocker");
    roundInterface.appendChild(blocker);

    const votingConfirmUI = document.createElement("div");
    votingConfirmUI.classList.add("votingConfirmUI");
    votingConfirmUI.innerHTML = `ARE YOU SURE YOU WANT TO CHANGE YOUR VOTE TO THIS PERSON?`
    roundInterface.appendChild(votingConfirmUI);

    const buttonYes = document.createElement("div");
    buttonYes.classList.add("buttonYes");
    buttonYes.innerHTML = `YES`;
    buttonYes.addEventListener("click", () => {
      const oldVote = players[playerId].voteFor;
      const voteUpdate = players[oldVote].votes - 1;
      firebase.database().ref(`players/${oldVote}/votes`).set(voteUpdate);

      document.querySelector(".myVote").remove();
      
      confirmYes(ID, roundInterface);
    });
    document.querySelector(".votingConfirmUI").appendChild(buttonYes);

    const buttonNo = document.createElement("div");
    buttonNo.classList.add("buttonNo");
    buttonNo.innerHTML = `NO`;
    buttonNo.addEventListener("click", () => {
      confirmNo(ID)
    });
    document.querySelector(".votingConfirmUI").appendChild(buttonNo);
  }


  // MAFIA VOTING

  function startMafiaWaiting() {
    const mafiaInterface = document.createElement("div");
    mafiaInterface.classList.add("mafiaInterface");
    document.querySelector(".gameInterface").appendChild(mafiaInterface);

    const votingUITop = document.createElement("div");
    votingUITop.classList.add("votingUITop");
    votingUITop.innerHTML = `THE MAFIA ARE MEETING`
    document.querySelector(".mafiaInterface").appendChild(votingUITop);

    inMafiaVoting = true;
  }

  function startMafiaVoting() {
    const mafiaInterface = document.createElement("div");
    mafiaInterface.classList.add("mafiaInterface");
    document.querySelector(".gameInterface").appendChild(mafiaInterface);

    const votingUITop = document.createElement("div");
    votingUITop.classList.add("votingUITop");
    votingUITop.innerHTML = `WHO WOULD THE MAFIA LIKE TO KILL?`
    document.querySelector(".mafiaInterface").appendChild(votingUITop);

    Object.keys(players).forEach((key) => {
      if (!players[key].mafia) {
        const divLeft = (16 * (players[key].x - players[playerId].x)) + 193 + "px";
        const button = document.createElement("div");
        button.classList.add("b3");
        const p = key
        button.addEventListener("click", () => {
          if (players[playerId].voteFor === "none") {
            const potentialVote = document.createElement("div");
            potentialVote.classList.add("potentialVote");
            const divLeft = (16 * (players[p].x - players[playerId].x)) + 197 + "px";
            potentialVote.style.left = divLeft;
            document.querySelector(".mafiaInterface").appendChild(potentialVote);

            confirmVote(p, mafiaInterface);
          }
          else if (players[playerId].voteFor !== p) {
            const potentialVote = document.createElement("div");
            potentialVote.classList.add("potentialVote");
            const divLeft = (16 * (players[p].x - players[playerId].x)) + 197 + "px";
            potentialVote.style.left = divLeft;
            document.querySelector(".mafiaInterface").appendChild(potentialVote);

            changeVote(p, mafiaInterface);
          }
        });
        button.style.left = divLeft;
        document.querySelector(".mafiaInterface").appendChild(button);

        const voteCounter = document.createElement("div");
        voteCounter.classList.add("voteCounter");
        voteCounter.classList.add("user-" + p);
        voteCounter.style.left = divLeft;
        voteCounter.innerHTML = `0`;
        document.querySelector(".mafiaInterface").appendChild(voteCounter);
      }
    });
    inMafiaVoting = true;
  }
  
  function checkMafiaVoting(){
    let numMafia = 0;
    const numPlayer = playerOrder.length;
    if (numPlayer === 2) {
      numMafia = 1;
    }
    else if (numPlayer === 3) {
      numMafia = 1;
    }
    else if (numPlayer === 4) {
      numMafia = 1;
    }
    else if (numPlayer === 5) {
      numMafia = 2;
    }
    else if (numPlayer === 6) {
      numMafia = 2;
    }
    else if (numPlayer === 7) {
      numMafia = 2;
    }
    else if (numPlayer === 8) {
      numMafia = 3;
    }
    else if (numPlayer === 9) {
      numMafia = 3;
    }
    else if (numPlayer === 10) {
      numMafia = 3;
    }
    else if (numPlayer === 11) {
      numMafia = 4;
    }
    else if (numPlayer === 12) {
      numMafia = 4;
    }
    Object.keys(players).forEach((key) => {
      if (players[key].votes === numMafia && inMafiaVoting) {
        inMafiaVoting = false;
        endMafiaVoting(key);
      }
    });
  }

  function endMafiaVoting(votedPlayer) {

    if (playerOrder[0] === playerId) {
      firebase.database().ref(`votes`).update({
        mafiaVote: votedPlayer,
      });

      setTimeout(function () {
        Object.keys(players).forEach((key) => {
          firebase.database().ref(`players/${key}`).update({
            votes: 0,
            voteFor: "none",
          });
        });
      }, 1800);
    }

    const blocker = document.createElement("div");
    blocker.classList.add("blocker");
    document.querySelector(".mafiaInterface").appendChild(blocker);

    document.querySelector(".votingUITop").classList.add("votingUITopClose");
    document.querySelector(".votingUITop").classList.remove("votingUITop");
    setTimeout(function () {
      document.querySelector(".mafiaInterface").remove();
    }, 1600);
    setTimeout(function () {
      if (players[playerId].halo) {
        startAngelVoting();
      }
      else {
        startAngelWaiting();
      }
    }, 2300);
  }

  // ANGEL VOTING
  function startAngelWaiting() {
    if (!isAngel) {
      if (players[playerId].magnifyingGlass) {
        startDetectiveVoting();
        return;
      }
      else {
        startDetectiveWaiting();
        return;
      }
    }
    const angelInterface = document.createElement("div");
    angelInterface.classList.add("angelInterface");
    document.querySelector(".gameInterface").appendChild(angelInterface);

    const votingUITop = document.createElement("div");
    votingUITop.classList.add("votingUITop");
    votingUITop.innerHTML = `THE ANGEL IS SAVING SOMEONE`
    document.querySelector(".angelInterface").appendChild(votingUITop);

    inAngelVoting = true;
  }

  function startAngelVoting() {
    const angelInterface = document.createElement("div");
    angelInterface.classList.add("angelInterface");
    document.querySelector(".gameInterface").appendChild(angelInterface);

    const votingUITop = document.createElement("div");
    votingUITop.classList.add("votingUITop");
    votingUITop.innerHTML = `WHO WOULD THE ANGEL LIKE TO SAVE?`
    document.querySelector(".angelInterface").appendChild(votingUITop);

    Object.keys(players).forEach((key) => {
      const divLeft = (16 * (players[key].x - players[playerId].x)) + 193 + "px";
      const button = document.createElement("div");
      button.classList.add("b3");
      const p = key
      button.addEventListener("click", () => {
        if (players[playerId].voteFor === "none") {
          const potentialVote = document.createElement("div");
          potentialVote.classList.add("potentialVote");
          const divLeft = (16 * (players[p].x - players[playerId].x)) + 197 + "px";
          potentialVote.style.left = divLeft;
          document.querySelector(".angelInterface").appendChild(potentialVote);
          confirmVote(p, angelInterface);
        }
      });
      button.style.left = divLeft;
      document.querySelector(".angelInterface").appendChild(button);
      const voteCounter = document.createElement("div");
      voteCounter.classList.add("voteCounter");
      voteCounter.classList.add("user-" + p);
      voteCounter.style.left = divLeft;
      voteCounter.innerHTML = `0`;
      document.querySelector(".angelInterface").appendChild(voteCounter);
    });
    inAngelVoting = true;
  }
  
  function checkAngelVoting(){
    Object.keys(players).forEach((key) => {
      if (players[key].votes === 1 && inAngelVoting) {
        inAngelVoting = false;
        endAngelVoting(key);
      }
    });
  }

  function endAngelVoting(votedPlayer) {

    if (playerOrder[0] === playerId) {
      firebase.database().ref(`votes`).update({
        angelVote: votedPlayer,
      });
      setTimeout(function () {
        Object.keys(players).forEach((key) => {
          firebase.database().ref(`players/${key}`).update({
            votes: 0,
            voteFor: "none",
          });
        });
      }, 1800);
    }

    const blocker = document.createElement("div");
    blocker.classList.add("blocker");
    document.querySelector(".angelInterface").appendChild(blocker);

    document.querySelector(".votingUITop").classList.add("votingUITopClose");
    document.querySelector(".votingUITop").classList.remove("votingUITop");
    setTimeout(function () {
      document.querySelector(".angelInterface").remove();
    }, 1600);
    setTimeout(function () {
      if (players[playerId].magnifyingGlass) {
        startDetectiveVoting();
      }
      else {
        startDetectiveWaiting();
      }
    }, 2300);
  }
  // DETECTIVE VOTING
  
  function startDetectiveWaiting() {
    if (!isDetective) {
      if (players[playerId].gun) {
        startShooterVoting();
        return;
      }
      else {
        startShooterWaiting();
        return;
      }
    }
    const detectiveInterface = document.createElement("div");
    detectiveInterface.classList.add("detectiveInterface");
    document.querySelector(".gameInterface").appendChild(detectiveInterface);

    const votingUITop = document.createElement("div");
    votingUITop.classList.add("votingUITop");
    votingUITop.innerHTML = `THE DETECTIVE IS INVESTIGATING SOMEONE`
    document.querySelector(".detectiveInterface").appendChild(votingUITop);

    inDetectiveVoting = true;
  }

  function startDetectiveVoting() {
    const detectiveInterface = document.createElement("div");
    detectiveInterface.classList.add("detectiveInterface");
    document.querySelector(".gameInterface").appendChild(detectiveInterface);

    const votingUITop = document.createElement("div");
    votingUITop.classList.add("votingUITop");
    votingUITop.innerHTML = `WHO WOULD THE DETECTIVE LIKE TO INVESTIGATE?`
    document.querySelector(".detectiveInterface").appendChild(votingUITop);

    Object.keys(players).forEach((key) => {
      if (!players[key].magnifyingGlass) {
        const divLeft = (16 * (players[key].x - players[playerId].x)) + 193 + "px";
        const button = document.createElement("div");
        button.classList.add("b3");
        const p = key
        button.addEventListener("click", () => {
          if (players[playerId].voteFor === "none") {
            const potentialVote = document.createElement("div");
            potentialVote.classList.add("potentialVote");
            const divLeft = (16 * (players[p].x - players[playerId].x)) + 197 + "px";
            potentialVote.style.left = divLeft;
            document.querySelector(".detectiveInterface").appendChild(potentialVote);
          
            confirmVote(p, detectiveInterface);
          }
        });
        button.style.left = divLeft;
        document.querySelector(".detectiveInterface").appendChild(button);
       
        const voteCounter = document.createElement("div");
        voteCounter.classList.add("voteCounter");
        voteCounter.classList.add("user-" + p);
        voteCounter.style.left = divLeft;
        voteCounter.innerHTML = `0`;
        document.querySelector(".detectiveInterface").appendChild(voteCounter);
      }
    });
    inDetectiveVoting = true;
  }
  
  function checkDetectiveVoting(){
    Object.keys(players).forEach((key) => {
      if (players[key].votes === 1 && inDetectiveVoting) {
        inDetectiveVoting = false;
        endDetectiveVoting(key);
      }
    });
  }

  function endDetectiveVoting(votedPlayer) {

    if (playerOrder[0] === playerId) {
      firebase.database().ref(`votes`).update({
        detectiveVote: votedPlayer,
      });
      setTimeout(function () {
        Object.keys(players).forEach((key) => {
          firebase.database().ref(`players/${key}`).update({
            votes: 0,
            voteFor: "none",
          });
        });
      }, 1800);
    }

    const blocker = document.createElement("div");
    blocker.classList.add("blocker");
    document.querySelector(".detectiveInterface").appendChild(blocker);

    document.querySelector(".votingUITop").classList.add("votingUITopClose");
    document.querySelector(".votingUITop").classList.remove("votingUITop");
    setTimeout(function () {
      document.querySelector(".detectiveInterface").remove();
    }, 1600);
    setTimeout(function () {
      if (players[playerId].gun) {
        startShooterVoting();
      }
      else {
        startShooterWaiting();
      }
    }, 2300);
  }
  // SHOOTER VOTING
  
  function startShooterWaiting() {
    if (!isShooter) {
      announceMafiaKill();
      return;
    }
    const shooterInterface = document.createElement("div");
    shooterInterface.classList.add("shooterInterface");
    document.querySelector(".gameInterface").appendChild(shooterInterface);

    const votingUITop = document.createElement("div");
    votingUITop.classList.add("votingUITop");
    votingUITop.innerHTML = `THE SHOOTER IS CHOOSING SOMEONE TO TAKE OUT`
    document.querySelector(".shooterInterface").appendChild(votingUITop);

    inShooterVoting = true;
  }

  function startShooterVoting() {
    const shooterInterface = document.createElement("div");
    shooterInterface.classList.add("shooterInterface");
    document.querySelector(".gameInterface").appendChild(shooterInterface);

    const votingUITop = document.createElement("div");
    votingUITop.classList.add("votingUITop");
    votingUITop.innerHTML = `WHO WOULD THE SHOOTER LIKE TO TAKE OUT?`
    document.querySelector(".shooterInterface").appendChild(votingUITop);

    Object.keys(players).forEach((key) => {
      if (!players[key].gun) {
        const divLeft = (16 * (players[key].x - players[playerId].x)) + 193 + "px";
        const button = document.createElement("div");
        button.classList.add("b3");
        const p = key
        button.addEventListener("click", () => {
          if (players[playerId].voteFor === "none") {
            const potentialVote = document.createElement("div");
            potentialVote.classList.add("potentialVote");
            const divLeft = (16 * (players[p].x - players[playerId].x)) + 197 + "px";
            potentialVote.style.left = divLeft;
            document.querySelector(".shooterInterface").appendChild(potentialVote);
          
            confirmVote(p, shooterInterface);
          }
        });
        button.style.left = divLeft;
        document.querySelector(".shooterInterface").appendChild(button);
       
        const voteCounter = document.createElement("div");
        voteCounter.classList.add("voteCounter");
        voteCounter.classList.add("user-" + p);
        voteCounter.style.left = divLeft;
        voteCounter.innerHTML = `0`;
        document.querySelector(".shooterInterface").appendChild(voteCounter);
      }
    });

    const shooterSkipButton = document.createElement("div");
    shooterSkipButton.classList.add("shooterSkipButton");
    shooterSkipButton.innerHTML = `SKIP`
    shooterSkipButton.addEventListener("click", () => {
      confirmSkip();
    })
    document.querySelector(".shooterInterface").appendChild(shooterSkipButton);

    inShooterVoting = true;
  }

  function confirmSkip() {
    const blocker = document.createElement("div");
    blocker.classList.add("blocker");
    document.querySelector(".shooterInterface").appendChild(blocker);

    const skipConfirmUI = document.createElement("div");
    skipConfirmUI.classList.add("votingConfirmUI");
    skipConfirmUI.innerHTML = `ARE YOU SURE YOU WANT TO SKIP?`
    document.querySelector(".shooterInterface").appendChild(skipConfirmUI);

    const buttonYes = document.createElement("div");
    buttonYes.classList.add("buttonYes");
    buttonYes.innerHTML = `YES`;
    buttonYes.addEventListener("click", () => {
      document.querySelector(".votingConfirmUI").classList.add("votingConfirmUIClose");
      document.querySelector(".votingConfirmUI").classList.remove("votingConfirmUI");
      document.querySelector(".blocker").remove();
      setTimeout(function () {
        document.querySelector(".votingConfirmUIClose").remove();
        firebase.database().ref(`players/${playerId}`).update({
          votes: 1,
        });
      }, 1200);
    });
    document.querySelector(".votingConfirmUI").appendChild(buttonYes);

    const buttonNo = document.createElement("div");
    buttonNo.classList.add("buttonNo");
    buttonNo.innerHTML = `NO`;
    buttonNo.addEventListener("click", () => {
      document.querySelector(".votingConfirmUI").classList.add("votingConfirmUIClose");
      document.querySelector(".votingConfirmUI").classList.remove("votingConfirmUI");
      document.querySelector(".blocker").remove();
      setTimeout(function () {
        document.querySelector(".votingConfirmUIClose").remove();
      }, 1200);
    });
    document.querySelector(".votingConfirmUI").appendChild(buttonNo);
  }
  
  function checkShooterVoting(){
    Object.keys(players).forEach((key) => {
      if (players[key].votes === 1 && inShooterVoting) {
        inShooterVoting = false;
        endShooterVoting(key);
      }
    });
  }

  function endShooterVoting(votedPlayer) {
    if (playerOrder[0] === playerId) {
      if (players[votedPlayer].gun) {
        firebase.database().ref(`votes`).update({
          shooterVote: "none",
        });
      }
      else {
        firebase.database().ref(`votes`).update({
          shooterVote: votedPlayer,
        });
      }
      setTimeout(function () {
        Object.keys(players).forEach((key) => {
          firebase.database().ref(`players/${key}`).update({
            votes: 0,
            voteFor: "none",
          });
        });
      }, 1800);
    }

    const blocker = document.createElement("div");
    blocker.classList.add("blocker");
    document.querySelector(".shooterInterface").appendChild(blocker);

    document.querySelector(".votingUITop").classList.add("votingUITopClose");
    document.querySelector(".votingUITop").classList.remove("votingUITop");
    setTimeout(function () {
      document.querySelector(".shooterInterface").remove();
    }, 1600);
    setTimeout(function () {
      announceMafiaKill();
    }, 2300);
  }

  // ANNOUNCEMENTS

  function announceMafiaKill() {
    const mafiaNotification = document.createElement("div");
    mafiaNotification.classList.add("notification");
    document.querySelector(".gameInterface").appendChild(mafiaNotification);

    const mafiaKill = players[votesRef.mafiaVote].name;

    mafiaNotification.innerHTML = `THE MAFIA WENT AFTER ${mafiaKill}`;

    setTimeout(function () {
      mafiaNotification.classList.add("notificationClose");
      mafiaNotification.classList.remove("notification");
    }, 4000);

    setTimeout(function () {
      document.querySelector(".notificationClose").remove();
      announceShooterKill();
    }, 5000);
  }

  function announceShooterKill() {
    if (!isShooter) {
      exectuteMafiaKill();
      return;
    }
    const shooterNotification = document.createElement("div");
    shooterNotification.classList.add("notification");
    document.querySelector(".gameInterface").appendChild(shooterNotification);

    const shooterKill = votesRef.shooterVote;

    if (shooterKill === "none") {
      shooterNotification.innerHTML = `THE SHOOTER DID NOT GO AFTER ANYONE`;
    }
    else {
      shooterNotification.innerHTML = `THE SHOOTER WENT AFTER ${players[shooterKill].name}`;
    }

    setTimeout(function () {
      shooterNotification.classList.add("notificationClose");
      shooterNotification.classList.remove("notification");
    }, 4000);

    setTimeout(function () {
      document.querySelector(".notificationClose").remove();
      exectuteMafiaKill();
    }, 5000);
  }

  // EXECUTE: KILL - SAVE - INVESTIGATE

  function exectuteMafiaKill() {
    const executeMafiaKillNotification = document.createElement("div");
    executeMafiaKillNotification.classList.add("notification");
    document.querySelector(".gameInterface").appendChild(executeMafiaKillNotification);

    let successfulKill = false;

    let goToShooter = true;

    if (votesRef.shooterVote === "none") {
      goToShooter = false;
    }

    const mafiaKill = players[votesRef.mafiaVote].name;

    if (votesRef.angelVote === votesRef.mafiaVote && votesRef.mafiaVote === votesRef.shooterVote) {
      executeMafiaKillNotification.innerHTML = `THE ANGEL SAVED ${mafiaKill} FROM THE MAFIA AND THE SHOOTER`;
      goToShooter = false;
    }
    else if (votesRef.angelVote === votesRef.mafiaVote){
      executeMafiaKillNotification.innerHTML = `THE ANGEL SAVED ${mafiaKill} FROM THE MAFIA`;
    }
    else {
      successfulKill = true;
      executeMafiaKillNotification.innerHTML = `THE MAFIA SUCCESSFULLY KILLED ${mafiaKill}`;
    }

    setTimeout(function () {
      executeMafiaKillNotification.classList.add("notificationClose");
      executeMafiaKillNotification.classList.remove("notification");
    }, 4000);
    
    setTimeout(function () {
      document.querySelector(".notificationClose").remove();
      if (successfulKill) {

        deathAnimation(votesRef.mafiaVote);

        setTimeout(function () {
          firebase.database().ref(`players/${votesRef.mafiaVote}`).update({
            char: "ghost",
            alive: false,
          });
        }, 1000);

        setTimeout(function () {
          if (goToShooter) {
            exectuteShooterKill();
          }
          else {
            exectuteInvestigation();
          }
        }, 2000);
      }
      else {
        if (goToShooter) {
          exectuteShooterKill();
        }
        else {
          exectuteInvestigation();
        }
      }
    }, 5000);
  }

  function exectuteShooterKill() {
    const executeShooterKillNotification = document.createElement("div");
    executeShooterKillNotification.classList.add("notification");
    document.querySelector(".gameInterface").appendChild(executeShooterKillNotification);

    let successfulKill = false;

    const shooterKill = players[votesRef.shooterVote].name;

    if (votesRef.angelVote === votesRef.shooterVote) {
      executeShooterKillNotification.innerHTML = `THE ANGEL SAVED ${shooterKill} FROM THE SHOOTER`;
    }
    else {
      successfulKill = true;
      executeShooterKillNotification.innerHTML = `THE SHOOTER SUCCESSFULLY KILLED ${shooterKill}`;
    }

    setTimeout(function () {
      executeShooterKillNotification.classList.add("notificationClose");
      executeShooterKillNotification.classList.remove("notification");
    }, 4000);

    setTimeout(function () {
      document.querySelector(".notificationClose").remove();
      if (successfulKill) {

        deathAnimation(votesRef.shooterVote);

        setTimeout(function () {
          firebase.database().ref(`players/${votesRef.shooterVote}`).update({
            char: "ghost",
            alive: false,
          });
        }, 1000);

        setTimeout(function () {
          exectuteInvestigation();
        }, 2000);
      }
      else {
        exectuteInvestigation();
      }
    }, 5000);
  }

  function exectuteInvestigation() {
    if (!isDetective) {
      if (players[playerId].votingCard) {
        startTownVoting();
      }
      else {
        startTownWaiting();
      }
      return;
    }
    const executeInvestigationNotification = document.createElement("div");
    executeInvestigationNotification.classList.add("notification");
    document.querySelector(".gameInterface").appendChild(executeInvestigationNotification);

    const suspect = votesRef.detectiveVote;

    if (players[playerId].magnifyingGlass) {
      if (players[suspect].mafia) {
        executeInvestigationNotification.innerHTML = `${players[suspect].name} IS IN THE MAFIA`;
      }
      else {
        executeInvestigationNotification.innerHTML = `${players[suspect].name} IS A NORMIE`;
      }
    }
    else {
      executeInvestigationNotification.innerHTML = `THE DETECTIVE HAS CONCLUDED THEIR INVESTIGATION`;
    }

    setTimeout(function () {
      executeInvestigationNotification.classList.add("notificationClose");
      executeInvestigationNotification.classList.remove("notification");
    }, 4000);

    setTimeout(function () {
      document.querySelector(".notificationClose").remove();
      if (players[playerId].votingCard) {
        startTownVoting();
      }
      else {
        startTownWaiting();
      }
    }, 5000);
  }

  function deathAnimation(deathUser) {
    const divLeft = (16 * (players[deathUser].x - players[playerId].x)) + 185 + "px";

    const bomb = document.createElement("div");
    bomb.classList.add("bomb");
    bomb.style.left = divLeft;
    document.querySelector(".gameInterface").appendChild(bomb);

    const explosionSpace = document.createElement("div");
    explosionSpace.classList.add("explosionSpace");
    explosionSpace.style.left = divLeft;
    document.querySelector(".gameInterface").appendChild(explosionSpace);

    setTimeout(function () {
      const explosion = document.createElement("div");
      explosion.classList.add("explosion");
      document.querySelector(".explosionSpace").appendChild(explosion);

      document.querySelector(".bomb").remove();

      setTimeout(function () {
        document.querySelector(".explosionSpace").remove();
      }, 400);
    }, 800);
  }

  // TOWN VOTING

  function startTownWaiting() {
    if (!isVoters) {
      console.log("START NEW ROUND");
      teleportTo(85,60);
      setTimeout(function() {
        if (!inRound) {
          nextRound();
        }
      }, 800);
      return;
    }

    const townInterface = document.createElement("div");
    townInterface.classList.add("townInterface");
    document.querySelector(".gameInterface").appendChild(townInterface);

    const votingUITop = document.createElement("div");
    votingUITop.classList.add("votingUITop");
    votingUITop.innerHTML = `THE TOWNS PEOPLE ARE MEETING`
    document.querySelector(".townInterface").appendChild(votingUITop);

    inTownVoting = true;
  }

  function startTownVoting() {
    const townInterface = document.createElement("div");
    townInterface.classList.add("townInterface");
    document.querySelector(".gameInterface").appendChild(townInterface);

    const votingUITop = document.createElement("div");
    votingUITop.classList.add("votingUITop");
    votingUITop.innerHTML = `WHO DO THE TOWNS PEOPLE THINK IS IN THE MAFIA?`
    document.querySelector(".townInterface").appendChild(votingUITop);

    Object.keys(players).forEach((key) => {
      const divLeft = (16 * (players[key].x - players[playerId].x)) + 193 + "px";
      const p = key
      if (key !== playerId) {
        const button = document.createElement("div");
        button.classList.add("b3");
        button.addEventListener("click", () => {
          if (players[playerId].voteFor === "none") {
            const potentialVote = document.createElement("div");
            potentialVote.classList.add("potentialVote");
            const divLeft = (16 * (players[p].x - players[playerId].x)) + 197 + "px";
            potentialVote.style.left = divLeft;
            document.querySelector(".townInterface").appendChild(potentialVote);

            confirmVote(p, townInterface);
          }
          else if (players[playerId].voteFor !== p) {
            const potentialVote = document.createElement("div");
            potentialVote.classList.add("potentialVote");
            const divLeft = (16 * (players[p].x - players[playerId].x)) + 197 + "px";
            potentialVote.style.left = divLeft;
            document.querySelector(".townInterface").appendChild(potentialVote);

            changeVote(p, townInterface);
          }
        });
        button.style.left = divLeft;
        document.querySelector(".townInterface").appendChild(button);
      }
      const voteCounter = document.createElement("div");
      voteCounter.classList.add("voteCounter");
      voteCounter.classList.add("user-" + p);
      voteCounter.style.left = divLeft;
      voteCounter.innerHTML = `0`;
      document.querySelector(".townInterface").appendChild(voteCounter);
    });
    inTownVoting = true;
  }
  
  function checkTownVoting(){
    let numVotes = 0;
    Object.keys(players).forEach((key) => {
      if (players[key].votingCard) {
        numVotes++;
      }
    });
    console.log("numVotes");
    Object.keys(players).forEach((key) => {
      if (players[key].votes >= Math.ceil(numVotes/2) && inTownVoting) {
        inTownVoting = false;
        endTownVoting(key);
      }
    });
  }

  function endTownVoting(votedPlayer) {
    console.log("END TOWN VOTING");

    if (playerOrder[0] === playerId) {
      firebase.database().ref(`votes`).update({
        townVote: votedPlayer,
      });

      setTimeout(function () {
        Object.keys(players).forEach((key) => {
          firebase.database().ref(`players/${key}`).update({
            votes: 0,
            voteFor: "none",
          });
        });
      }, 1800);
    }

    const blocker = document.createElement("div");
    blocker.classList.add("blocker");
    document.querySelector(".townInterface").appendChild(blocker);

    document.querySelector(".votingUITop").classList.add("votingUITopClose");
    document.querySelector(".votingUITop").classList.remove("votingUITop");
    setTimeout(function () {
      document.querySelector(".townInterface").remove();
    }, 1600);
    setTimeout(function () {
      console.log("START NEW ROUND");
      teleportTo(85,60);
      setTimeout(function() {
        if (!inRound) {
          nextRound();
        }
      }, 800);
    }, 2300);
  }

  function updateDom() {
    Object.keys(players).forEach((key) => {
      const characterState = players[key];
      let el = playerElements[key];
      
      el.setAttribute("data-char", characterState.char);
      el.setAttribute("data-direction", characterState.direction);
      el.setAttribute("data-walking", characterState.walking);

      const left = 16 * (characterState.x - players[playerId].x + 12) + "px";
      const top = 16 * (characterState.y - players[playerId].y + 7) - 1 + "px";

      el.style.transform = `translate3d(${left}, ${top}, 0)`;
      
      if (key == playerId) {
        if (inMafiaVoting) {
          checkMafiaVoting();
        }

        if (inAngelVoting) {
          checkAngelVoting();
        }

        if (inDetectiveVoting) {
          checkDetectiveVoting();
        }

        if (inShooterVoting) {
          checkShooterVoting();
        }

        if (inTownVoting) {
          checkTownVoting();
        }

        attemptGrabVotingCard(players[playerId].x, players[playerId].y);
        attemptGrabGun(players[playerId].x, players[playerId].y);
        attemptGrabFlashlight(players[playerId].x, players[playerId].y);
        attemptGrabMagnifyingGlass(players[playerId].x, players[playerId].y);
        attemptGrabHalo(players[playerId].x, players[playerId].y);

        const ML = ((startingX - players[playerId].x) * 16) + 'px';
        const MT = ((startingY - players[playerId].y) * 16) + 'px';

        document.querySelector(".mapUpper").style.transform = `translate3d(${ML}, ${MT}, 0)`;
        document.querySelector(".mapLower").style.transform = `translate3d(${ML}, ${MT}, 0)`;
      }
    });
    Object.keys(votingCards).forEach((key) => {
      let el = votingCardElements[key]
      const left = 16 * (votingCards[key].x - players[playerId].x + 12) + "px";
      const top = 16 * (votingCards[key].y - players[playerId].y + 7) + "px";
      el.style.transform = `translate3d(${left}, ${top}, 0)`;
    });
    Object.keys(guns).forEach((key) => {
      let el = gunElements[key]
      const left = 16 * (guns[key].x - players[playerId].x + 12) + "px";
      const top = 16 * (guns[key].y - players[playerId].y + 7) + "px";
      el.style.transform = `translate3d(${left}, ${top}, 0)`;
    });
    Object.keys(flashlights).forEach((key) => {
      let el = flashlightElements[key]
      const left = 16 * (flashlights[key].x - players[playerId].x + 12) + "px";
      const top = 16 * (flashlights[key].y - players[playerId].y + 7) + "px";
      el.style.transform = `translate3d(${left}, ${top}, 0)`;
    });
    Object.keys(magnifyingGlasses).forEach((key) => {
      let el = magnifyingGlassElements[key]
      const left = 16 * (magnifyingGlasses[key].x - players[playerId].x + 12) + "px";
      const top = 16 * (magnifyingGlasses[key].y - players[playerId].y + 7) + "px";
      el.style.transform = `translate3d(${left}, ${top}, 0)`;
    });
    Object.keys(halos).forEach((key) => {
      let el = haloElements[key]
      const left = 16 * (halos[key].x - players[playerId].x + 12) + "px";
      const top = 16 * (halos[key].y - players[playerId].y + 7) + "px";
      el.style.transform = `translate3d(${left}, ${top}, 0)`;
    });
  }

  function teleportTo(teleport_x, teleport_y) {
    //console.log("Teleport to: " + teleport_x + ", " + teleport_y);
    setTimeout(function() {
      playerRef.update({
        x: teleport_x,
        y: teleport_y,
      });
    }, 800);
    const sceneTransition = new SceneTransition();
    sceneTransition.init(document.querySelector(".game-container"), () => {})
    setTimeout(function() {   
      updateDom();
    }, 800);
    setTimeout(function() {
      sceneTransition.fadeOut();
      updateDom();
    }, 1200);
  }

  function placeItems() {
    placeFlashlight();
    placeGun();
    placeVotingCard();
    placeMagnifyingGlass();
    placeHalo();
  }

  function placeVotingCard() {
    const {i,j} = getRandomVotingCardSpot();
    let x = i;
    let y = j;
    let key = getKeyString(x, y);
    while (votingCards[key] !== undefined) {
      let {i,j} = getRandomVotingCardSpot();
      x = i;
      y = j;
      key = getKeyString(x, y);
    }
    //console.log("NEW VOTING CARD: " + key + " / " + x + ", " + y);
    const votingCardRef = firebase.database().ref(`votingCard/${key}`);
    votingCardRef.set({
      x,
      y,
    })
  }

  function placeGun() {
    const {i,j} = getRandomGunSpot();
    let x = i;
    let y = j;
    let key = getKeyString(x, y);
    while (guns[key] !== undefined) {
      let {i,j} = getRandomGunSpot();
      x = i;
      y = j;
      key = getKeyString(x, y);
    }
    //console.log("NEW GUN: " + key + " / " + x + ", " + y);
    const gunRef = firebase.database().ref(`gun/${key}`);
    gunRef.set({
      x,
      y,
    })
  }

  function placeFlashlight() {
    const {i,j} = getRandomFlashlightSpot();
    let x = i;
    let y = j;
    let key = getKeyString(x, y);
    while (flashlights[key] !== undefined) {
      let {i,j} = getRandomFlashlightSpot();
      x = i;
      y = j;
      key = getKeyString(x, y);
    }
    //console.log("NEW FLASHLIGHT: " + key + " / " + x + ", " + y);
    const flashlightRef = firebase.database().ref(`flashlight/${key}`);
    flashlightRef.set({
      x,
      y,
    })
  }

  function placeMagnifyingGlass() {
    const {i,j} = getRandomMagnifyingGlassSpot();
    let x = i;
    let y = j;
    let key = getKeyString(x, y);
    while (magnifyingGlasses[key] !== undefined) {
      let {i,j} = getRandomMagnifyingGlassSpot();
      x = i;
      y = j;
      key = getKeyString(x, y);
    }
    //console.log("NEW MAGNIFYING GLASS: " + key + " / " + x + ", " + y);
    const magnifyingGlassRef = firebase.database().ref(`magnifyingGlass/${key}`);
    magnifyingGlassRef.set({
      x,
      y,
    })
  }

  function placeHalo() {
    const {i,j} = getRandomHaloSpot();
    let x = i;
    let y = j;
    let key = getKeyString(x, y);
    while (halos[key] !== undefined) {
      let {i,j} = getRandomHaloSpot();
      x = i;
      y = j;
      key = getKeyString(x, y);
    }
    //console.log("NEW HALO: " + key + " / " + x + ", " + y);
    const haloRef = firebase.database().ref(`halo/${key}`);
    haloRef.set({
      x,
      y,
    })
  }

  function attemptGrabVotingCard(x, y) {
    const key = getKeyString(x, y);
    if (votingCards[key] && !players[playerId].votingCard) {
      document.querySelector(".votingCardIcon").style.background = "url(images/items/voting_cardIcon.png)";
      playerRef.update({
        votingCard: true,
      })
      firebase.database().ref(`votingCard/${key}`).remove();
    }
  }

  function attemptGrabGun(x, y) {
    const key = getKeyString(x, y);
    if (guns[key] && !players[playerId].gun) {
      document.querySelector(".gunIcon").style.background = "url(images/items/gunIcon.png)";
      playerRef.update({
        gun: true,
      })
      firebase.database().ref(`gun/${key}`).remove();
    }
  }

  function attemptGrabFlashlight(x, y) {
    const key = getKeyString(x, y);
    if (flashlights[key] && !players[playerId].flashlight) {
      document.querySelector(".flashlightIcon").style.background = "url(images/items/flashlightIcon.png)";
      playerRef.update({
        flashlight: true,
      });
      firebase.database().ref(`flashlight/${key}`).remove();
      const shadowBig = document.createElement("div");
      shadowBig.classList.add("shadowBig");
      document.querySelector(".gameInterface").appendChild(shadowBig);
      document.querySelector(".shadow").remove();
      if (players[playerId].direction === "right") {
        document.querySelector(".shadowBig").style.background = "url(images/maps/shadowRight.png)";
      }
      else if (players[playerId].direction === "left") {
        document.querySelector(".shadowBig").style.background = "url(images/maps/shadowLeft.png)";
      }
      else if (players[playerId].direction === "up") {
        document.querySelector(".shadowBig").style.background = "url(images/maps/shadowUp.png)";
      }
      else if (players[playerId].direction === "down") {
        document.querySelector(".shadowBig").style.background = "url(images/maps/shadowDown.png)";
      }
    }
  }

  function attemptGrabMagnifyingGlass(x, y) {
    const key = getKeyString(x, y);
    if (magnifyingGlasses[key] && !players[playerId].magnifyingGlass) {
      document.querySelector(".magnifyingGlassIcon").style.background = "url(images/items/magnifyingGlassIcon.png)";
      playerRef.update({
        magnifyingGlass: true,
      })
      firebase.database().ref(`magnifyingGlass/${key}`).remove();
    }
  }

  function attemptGrabHalo(x, y) {
    const key = getKeyString(x, y);
    if (halos[key] && !players[playerId].halo) {
      document.querySelector(".haloIcon").style.background = "url(images/items/haloIcon.png)";
      playerRef.update({
        halo: true,
      })
      firebase.database().ref(`halo/${key}`).remove();
    }
  }

  function walk(xChange=0, yChange=0, key) {
    if (heldKeys.indexOf(key) === 0) {
      let playerInNextSpace = false;
      const newX = players[playerId].x + xChange;
      const newY = players[playerId].y + yChange;
      if (xChange === 1 && (inRound || inLobby)) {
        players[playerId].direction = "right";
        if (inRound) {
          if (players[playerId].flashlight) {
            document.querySelector(".shadowBig").style.background = "url(images/maps/shadowRight.png)";
          }
          else {
            document.querySelector(".shadow").style.background = "url(images/maps/shadowRight.png)";
          }
        }
      }
      if (xChange === -1 && (inRound || inLobby)) {
        players[playerId].direction = "left";
        if (inRound) {
          if (players[playerId].flashlight) {
            document.querySelector(".shadowBig").style.background = "url(images/maps/shadowLeft.png)";
          }
          else {
            document.querySelector(".shadow").style.background = "url(images/maps/shadowLeft.png)";
          }
        }
      }
      if (yChange === -1 && (inRound || inLobby)) {
        players[playerId].direction = "up";
        if (inRound) {
          if (players[playerId].flashlight) {
            document.querySelector(".shadowBig").style.background = "url(images/maps/shadowUp.png)";
          }
          else {
            document.querySelector(".shadow").style.background = "url(images/maps/shadowUp.png)";
          }
        }
      }
      if (yChange === 1 && (inRound || inLobby)) {
        players[playerId].direction = "down";
        if (inRound) {
          if (players[playerId].flashlight) {
            document.querySelector(".shadowBig").style.background = "url(images/maps/shadowDown.png)";
          }
          else {
            document.querySelector(".shadow").style.background = "url(images/maps/shadowDown.png)";
          }
        }
      }
      for (const player in players) {
        if (players[player].x === newX && players[player].y === newY) {
          playerInNextSpace = true;
        }
      }
      if (((!isSolid(newX, newY) && !playerInNextSpace) || (newX == 133 && newY == 11)) && (inRound || inLobby)) {
        //move to the next space
        players[playerId].x = newX;
        players[playerId].y = newY;
      }
      playerRef.set(players[playerId]);
    }
    setTimeout(function() {
      const i = waitingKeys.indexOf(key);
      if (i > -1) {
        waitingKeys.splice(i, 1);
      }
      if (heldKeys.indexOf(key) !== -1){
        waitingKeys.unshift(key);
        walk(xChange, yChange, key);
      }
    }, 200);
  }

  function handleArrowPress(key) {
    if ((!inRound && !inLobby) || inTitleScreen) {
      return;
    }
    playerRef.update({
      walking: "yes"
    });
    const index = heldKeys.indexOf(key);
    if (waitingKeys.indexOf(key) === -1) {
      waitingKeys.unshift(key);
      if (index === -1) {
        heldKeys.unshift(key);
      }
      if (key === "ArrowUp" || key === "KeyW"){
        walk(0, -1, key);
      }
      if (key === "ArrowDown" || key === "KeyS"){
        walk(0, 1, key);
      }
      if (key === "ArrowLeft" || key === "KeyA"){
        walk(-1, 0, key);
      }
      if (key === "ArrowRight" || key === "KeyD"){
        walk(1, 0, key);
      }
    }
  }

  function handleArrowRelease(key) {
    const index = heldKeys.indexOf(key);
    if (index > -1) {
      heldKeys.splice(index, 1);
    }
    setTimeout(function() {
      if (heldKeys.length == 0){
        playerRef.update({
          walking: "no"
        });
      }
    }, 200);
  }

  function initGame() {

    new KeyPressListener("ArrowUp", () => handleArrowPress("ArrowUp"))
    new KeyPressListener("ArrowDown", () => handleArrowPress("ArrowDown"))
    new KeyPressListener("ArrowLeft", () => handleArrowPress("ArrowLeft"))
    new KeyPressListener("ArrowRight", () => handleArrowPress("ArrowRight"))
    new KeyPressListener("KeyW", () => handleArrowPress("KeyW"))
    new KeyPressListener("KeyS", () => handleArrowPress("KeyS"))
    new KeyPressListener("KeyA", () => handleArrowPress("KeyA"))
    new KeyPressListener("KeyD", () => handleArrowPress("KeyD"))
    new KeyPressListener("Space", () => placeItems())

    new KeyReleaseListener("ArrowUp", () => handleArrowRelease("ArrowUp"))
    new KeyReleaseListener("ArrowDown", () => handleArrowRelease("ArrowDown"))
    new KeyReleaseListener("ArrowLeft", () => handleArrowRelease("ArrowLeft"))
    new KeyReleaseListener("ArrowRight", () => handleArrowRelease("ArrowRight"))
    new KeyReleaseListener("KeyW", () => handleArrowRelease("KeyW"))
    new KeyReleaseListener("KeyS", () => handleArrowRelease("KeyS"))
    new KeyReleaseListener("KeyA", () => handleArrowRelease("KeyA"))
    new KeyReleaseListener("KeyD", () => handleArrowRelease("KeyD"))

    const allPlayersRef = firebase.database().ref(`players`);
    const allVotingCardRef = firebase.database().ref(`votingCard`);
    const allGunRef = firebase.database().ref(`gun`);
    const allFlashlightRef = firebase.database().ref(`flashlight`);
    const allMagnifyingGlassRef = firebase.database().ref(`magnifyingGlass`);
    const allHaloRef = firebase.database().ref(`halo`);
    const allVotesRef = firebase.database().ref(`votes`);

    allVotesRef.on("value", (snapshot) => {
      votesRef = snapshot.val() || {};
    });

    allPlayersRef.on("value", (snapshot) => {
      //Fires whenever a change occurs
      players = snapshot.val() || {};
      Object.keys(players).forEach((key) => {
        const characterState = players[key];
        let el = playerElements[key];
        // Now update the DOM
        el.setAttribute("data-char", characterState.char);
        el.setAttribute("data-direction", characterState.direction);
        el.setAttribute("data-walking", characterState.walking);
        const left = 16 * (characterState.x - players[playerId].x + 12) + "px";
        const top = 16 * (characterState.y - players[playerId].y + 7) - 1 + "px";

        if (inRound) {
          if (players[playerId].alive && players[key].alive) {
            el.style.transform = `translate3d(${left}, ${top}, 0)`;
          }
          else if (!players[playerId].alive && !players[key].alive) {
            el.style.transform = `translate3d(${left}, ${top}, 0)`;
          }
        }
        else {
          el.style.transform = `translate3d(${left}, ${top}, 0)`;
        }

        if (players[playerId].alive && players[playerId].alive)

        if (!inRound && !inLobby) {
          const voteCounter = document.querySelector(".user-" + key);
          if (voteCounter) {
            voteCounter.innerHTML = `${players[key].votes}`;
          }
        }

        if (key == playerId) {

          if (inMafiaVoting) {
            checkMafiaVoting();
          }

          if (inAngelVoting) {
            checkAngelVoting();
          }

          if (inDetectiveVoting) {
            checkDetectiveVoting();
          }

          if (inShooterVoting) {
            checkShooterVoting();
          }

          if (inTownVoting) {
            checkTownVoting();
          }

          //console.log(players[playerId].x + ", " + players[playerId].y);

          attemptGrabVotingCard(players[playerId].x, players[playerId].y);
          attemptGrabGun(players[playerId].x, players[playerId].y);
          attemptGrabFlashlight(players[playerId].x, players[playerId].y);
          attemptGrabMagnifyingGlass(players[playerId].x, players[playerId].y);
          attemptGrabHalo(players[playerId].x, players[playerId].y);

          const ML = ((startingX - players[playerId].x) * 16) + 'px';
          const MT = ((startingY - players[playerId].y) * 16) + 'px';

          document.querySelector(".mapUpper").style.transform = `translate3d(${ML}, ${MT}, 0)`;
          document.querySelector(".mapLower").style.transform = `translate3d(${ML}, ${MT}, 0)`;

          if (players[playerId].x === 133 && players[playerId].y === 11) {
            let allPlayersHere = true;
            Object.keys(players).forEach((key) => {
              if (players[key].x !== 133 || players[key].y !== 11) {
                allPlayersHere = false;
              }
            });
            if (allPlayersHere && inLobby) {
              inLobby = false;
              teleportTo(85,60);
              firstRound();
              setTimeout(function() {
                if (!inRound) {
                  startRound();
                }
              }, 800);
            }
          }
        }
      });
      Object.keys(votingCards).forEach((key) => {
        let el = votingCardElements[key]
        const left = 16 * (votingCards[key].x - players[playerId].x + 12) + "px";
        const top = 16 * (votingCards[key].y - players[playerId].y + 7) + "px";
        el.style.transform = `translate3d(${left}, ${top}, 0)`;
      });
      Object.keys(guns).forEach((key) => {
        let el = gunElements[key]
        const left = 16 * (guns[key].x - players[playerId].x + 12) + "px";
        const top = 16 * (guns[key].y - players[playerId].y + 7) + "px";
        el.style.transform = `translate3d(${left}, ${top}, 0)`;
      });
      Object.keys(flashlights).forEach((key) => {
        let el = flashlightElements[key]
        const left = 16 * (flashlights[key].x - players[playerId].x + 12) + "px";
        const top = 16 * (flashlights[key].y - players[playerId].y + 7) + "px";
        el.style.transform = `translate3d(${left}, ${top}, 0)`;
      });
      Object.keys(magnifyingGlasses).forEach((key) => {
        let el = magnifyingGlassElements[key]
        const left = 16 * (magnifyingGlasses[key].x - players[playerId].x + 12) + "px";
        const top = 16 * (magnifyingGlasses[key].y - players[playerId].y + 7) + "px";
        el.style.transform = `translate3d(${left}, ${top}, 0)`;
      });
      Object.keys(halos).forEach((key) => {
        let el = haloElements[key]
        const left = 16 * (halos[key].x - players[playerId].x + 12) + "px";
        const top = 16 * (halos[key].y - players[playerId].y + 7) + "px";
        el.style.transform = `translate3d(${left}, ${top}, 0)`;
      });
    });
    allPlayersRef.on("child_added", (snapshot) => {
      //Fires whenever a new node is added the tree
      const addedPlayer = snapshot.val();
      const characterElement = document.createElement("div");
      characterElement.classList.add("Character", "grid-cell");
      if (addedPlayer.id === playerId) {
        characterElement.classList.add("you");
      }
      characterElement.innerHTML = (`
        <div class="Character_shadow grid-cell"></div>
        <div class="Character_sprite grid-cell"></div>
        <div class="Character_you-arrow"></div>
      `);
      playerElements[addedPlayer.id] = characterElement;

      //Fill in some initial state
      characterElement.setAttribute("data-char", addedPlayer.char);
      characterElement.setAttribute("data-direction", addedPlayer.direction);
      characterElement.setAttribute("data-walking", addedPlayer.walking);
      const left = 16 * 12 + "px";
      const top = 16 * 7 - 1 + "px";
      characterElement.style.transform = `translate3d(${left}, ${top}, 0)`;
      gameContainer.appendChild(characterElement);
    });

    //Remove character DOM element after they leave
    allPlayersRef.on("child_removed", (snapshot) => {
      const removedKey = snapshot.val().id;
      gameContainer.removeChild(playerElements[removedKey]);
      delete playerElements[removedKey];
    });

    // VotingCards
    allVotingCardRef.on("value", (snapshot) => {
      votingCards = snapshot.val() || {};
    });
    allVotingCardRef.on("child_added", (snapshot) => {
      const votingCard = snapshot.val();
      const key = getKeyString(votingCard.x, votingCard.y);
      votingCards[key] = votingCard;

      const votingCardElement = document.createElement("div");
      votingCardElement.classList.add("votingCard", "grid-cell");
      votingCardElement.innerHTML = `
        <div class="VotingCard_shadow grid-cell"></div>
        <div class="VotingCard_sprite grid-cell"></div>
      `;

      const left = 16 * (votingCard.x - players[playerId].x + 12) + "px";
      const top = 16 * (votingCard.y - players[playerId].y + 7) + "px";
      votingCardElement.style.transform = `translate3d(${left}, ${top}, 0)`;

      votingCardElements[key] = votingCardElement;
      gameContainer.appendChild(votingCardElement);
    });
    allVotingCardRef.on("child_removed", (snapshot) => {
      const {x,y} = snapshot.val();
      //console.log("Voting Card removed: " + x + ", " + y);
      const keyToRemove = getKeyString(x,y);
      gameContainer.removeChild( votingCardElements[keyToRemove] );
      delete votingCardElements[keyToRemove];
    });

    // guns
    allGunRef.on("value", (snapshot) => {
      guns = snapshot.val() || {};
    });
    allGunRef.on("child_added", (snapshot) => {
      const gun = snapshot.val();
      const key = getKeyString(gun.x, gun.y);
      guns[key] = gun;

      const gunElement = document.createElement("div");
      gunElement.classList.add("gun", "grid-cell");
      gunElement.innerHTML = `
        <div class="Gun_shadow grid-cell"></div>
        <div class="Gun_sprite grid-cell"></div>
      `;

      const left = 16 * (gun.x - players[playerId].x + 12) + "px";
      const top = 16 * (gun.y - players[playerId].y + 7) + "px";
      gunElement.style.transform = `translate3d(${left}, ${top}, 0)`;

      gunElements[key] = gunElement;
      gameContainer.appendChild(gunElement);
    });
    allGunRef.on("child_removed", (snapshot) => {
      const {x,y} = snapshot.val();
      //console.log("Gun removed: " + x + ", " + y);
      const keyToRemove = getKeyString(x,y);
      gameContainer.removeChild( gunElements[keyToRemove] );
      delete gunElements[keyToRemove];
    });

    // flashlights
    allFlashlightRef.on("value", (snapshot) => {
      flashlights = snapshot.val() || {};
    });
    allFlashlightRef.on("child_added", (snapshot) => {
      const flashlight = snapshot.val();
      const key = getKeyString(flashlight.x, flashlight.y);
      flashlights[key] = flashlight;

      const flashlightElement = document.createElement("div");
      flashlightElement.classList.add("flashlight", "grid-cell");
      flashlightElement.innerHTML = `
        <div class="Flashlight_shadow grid-cell"></div>
        <div class="Flashlight_sprite grid-cell"></div>
      `;

      const left = 16 * (flashlight.x - players[playerId].x + 12) + "px";
      const top = 16 * (flashlight.y - players[playerId].y + 7) + "px";
      flashlightElement.style.transform = `translate3d(${left}, ${top}, 0)`;

      flashlightElements[key] = flashlightElement;
      gameContainer.appendChild(flashlightElement);
    });
    allFlashlightRef.on("child_removed", (snapshot) => {
      const {x,y} = snapshot.val();
      //console.log("Flashlight removed: " + x + ", " + y);
      const keyToRemove = getKeyString(x,y);
      gameContainer.removeChild( flashlightElements[keyToRemove] );
      delete flashlightElements[keyToRemove];
    });

    // magnifyingGlasses
    allMagnifyingGlassRef.on("value", (snapshot) => {
      magnifyingGlasses = snapshot.val() || {};
    });
    allMagnifyingGlassRef.on("child_added", (snapshot) => {
      const magnifyingGlass = snapshot.val();
      const key = getKeyString(magnifyingGlass.x, magnifyingGlass.y);
      magnifyingGlasses[key] = magnifyingGlass;

      const magnifyingGlassElement = document.createElement("div");
      magnifyingGlassElement.classList.add("magnifyingGlass", "grid-cell");
      magnifyingGlassElement.innerHTML = `
        <div class="MagnifyingGlass_shadow grid-cell"></div>
        <div class="MagnifyingGlass_sprite grid-cell"></div>
      `;

      const left = 16 * (magnifyingGlass.x - players[playerId].x + 12) + "px";
      const top = 16 * (magnifyingGlass.y - players[playerId].y + 7) + "px";
      magnifyingGlassElement.style.transform = `translate3d(${left}, ${top}, 0)`;

      magnifyingGlassElements[key] = magnifyingGlassElement;
      gameContainer.appendChild(magnifyingGlassElement);
    });
    allMagnifyingGlassRef.on("child_removed", (snapshot) => {
      const {x,y} = snapshot.val();
      //console.log("MagnifyingGlass removed: " + x + ", " + y);
      const keyToRemove = getKeyString(x,y);
      gameContainer.removeChild( magnifyingGlassElements[keyToRemove] );
      delete magnifyingGlassElements[keyToRemove];
    });

    // halos
    allHaloRef.on("value", (snapshot) => {
      halos = snapshot.val() || {};
    });
    allHaloRef.on("child_added", (snapshot) => {
      const halo = snapshot.val();
      const key = getKeyString(halo.x, halo.y);
      halos[key] = halo;

      const haloElement = document.createElement("div");
      haloElement.classList.add("halo", "grid-cell");
      haloElement.innerHTML = `
        <div class="Halo_shadow grid-cell"></div>
        <div class="Halo_sprite grid-cell"></div>
      `;

      const left = 16 * (halo.x - players[playerId].x + 12) + "px";
      const top = 16 * (halo.y - players[playerId].y + 7) + "px";
      haloElement.style.transform = `translate3d(${left}, ${top}, 0)`;

      haloElements[key] = haloElement;
      gameContainer.appendChild(haloElement);
    });
    allHaloRef.on("child_removed", (snapshot) => {
      const {x,y} = snapshot.val();
      //console.log("Halo removed: " + x + ", " + y);
      const keyToRemove = getKeyString(x,y);
      gameContainer.removeChild( haloElements[keyToRemove] );
      delete haloElements[keyToRemove];
    });

    playerSkinButton.addEventListener("click", () => {
      const mySkinIndex = skinID.indexOf(players[playerId].char);
      const nextSkin = skinID[mySkinIndex + 1] || skinID[0];
      playerRef.update({
        char: nextSkin
      });
      const skinPreview = document.querySelector(".skinPreview");
      if (nextSkin === "zero") {
        skinPreview.style.background="url(images/characters/0.png)";
      }
      if (nextSkin === "one") {
        skinPreview.style.background="url(images/characters/1.png)";
      }
      if (nextSkin === "two") {
        skinPreview.style.background="url(images/characters/2.png)";
      }
      if (nextSkin === "three") {
        skinPreview.style.background="url(images/characters/3.png)";
      }
      if (nextSkin === "four") {
        skinPreview.style.background="url(images/characters/4.png)";
      }
      if (nextSkin === "five") {
        skinPreview.style.background="url(images/characters/5.png)";
      }
      if (nextSkin === "six") {
        skinPreview.style.background="url(images/characters/6.png)";
      }
      if (nextSkin === "seven") {
        skinPreview.style.background="url(images/characters/7.png)";
      }
      if (nextSkin === "eight") {
        skinPreview.style.background="url(images/characters/8.png)";
      }
      if (nextSkin === "nine") {
        skinPreview.style.background="url(images/characters/9.png)";
      }
    });

    startButton.addEventListener("click", () => {
      document.querySelector('.stillScreen').remove();
      document.querySelector('.scrollScreen').remove();
      document.querySelector('.buttons').remove();
      setTimeout(function () {
        inTitleScreen = false;
      },200);
    });

  }

  firebase.auth().onAuthStateChanged((user) => {
    //console.log(user)
    if (user) {
      //You're logged in!
      playerId = user.uid;
      playerRef = firebase.database().ref(`players/${playerId}`);

      playerRef.set({
        name: "Tyson",
        id: playerId,
        direction: "down",
        char: "zero",
        x:startingX,
        y:startingY,
        walking: "no",
        alive: true,
        votingCard: false,
        gun: false,
        flashlight: false,
        magnifyingGlass: false,
        halo: false,
        votes: 0,
        voteFor: "none",
        mafia: false,
      });

      //Remove me from Firebase when I diconnect
      playerRef.onDisconnect().remove();

      //Begin the game now that we are signed in
      initGame();
    } else {
      //You're logged out.
    }
  });

  firebase.auth().signInAnonymously().catch((error) => {
    var errorCode = error.code;
    var errorMessage = error.message;
    // ...
    //console.log(errorCode, errorMessage);
  });


})();